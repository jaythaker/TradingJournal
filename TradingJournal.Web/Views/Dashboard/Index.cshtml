@model TradingJournal.Web.Models.DashboardMetricsDto
@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var accounts = ViewBag.Accounts as List<TradingJournal.Web.Models.AccountDto> ?? new List<TradingJournal.Web.Models.AccountDto>();
    var selectedAccountId = ViewBag.SelectedAccountId as string;
    var startDate = ViewBag.StartDate as DateTime?;
    var endDate = ViewBag.EndDate as DateTime?;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="accountId" class="form-label">Account</label>
                <select name="accountId" id="accountId" class="form-select">
                    <option value="">All Accounts</option>
                    @foreach (var account in accounts)
                    {
                        <option value="@account.Id" selected="@(account.Id == selectedAccountId)">@account.Name</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label for="startDate" class="form-label">Start Date</label>
                <input type="date" name="startDate" id="startDate" class="form-control" 
                       value="@(startDate?.ToString("yyyy-MM-dd"))" />
            </div>
            <div class="col-md-3">
                <label for="endDate" class="form-label">End Date</label>
                <input type="date" name="endDate" id="endDate" class="form-control" 
                       value="@(endDate?.ToString("yyyy-MM-dd"))" />
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-filter"></i> Apply Filters
                </button>
                <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle"></i> Clear
                </a>
            </div>
        </form>
    </div>
</div>

@if (ViewBag.Error != null)
{
    <div class="alert alert-warning">@ViewBag.Error</div>
}

<!-- Summary Cards Row 1 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card h-100 border-primary">
            <div class="card-body text-center">
                <h6 class="card-subtitle mb-2 text-muted">Total Realized P&L</h6>
                <h2 class="@(Model.TotalRealizedPnL >= 0 ? "text-success" : "text-danger")">
                    @(Model.TotalRealizedPnL >= 0 ? "+" : "")$@Model.TotalRealizedPnL.ToString("N2")
                </h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100 border-info">
            <div class="card-body text-center">
                <h6 class="card-subtitle mb-2 text-muted">Win Rate</h6>
                <h2 class="@(Model.WinRate >= 50 ? "text-success" : "text-warning")">
                    @Model.WinRate.ToString("N1")%
                </h2>
                <small class="text-muted">@Model.WinningTrades W / @Model.LosingTrades L</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100 border-success">
            <div class="card-body text-center">
                <h6 class="card-subtitle mb-2 text-muted">Avg. Wins/Day</h6>
                <h2 class="text-primary">@Model.AvgWinsPerDay.ToString("N2")</h2>
                <small class="text-muted">@Model.TradingDays trading days</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100 border-warning">
            <div class="card-body text-center">
                <h6 class="card-subtitle mb-2 text-muted">Total Dividends</h6>
                <h2 class="text-success">$@Model.TotalDividends.ToString("N2")</h2>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards Row 2 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <h6 class="card-subtitle mb-2 text-muted">Portfolio Value</h6>
                <h3 class="text-primary">$@Model.PortfolioValue.ToString("N2")</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <h6 class="card-subtitle mb-2 text-muted">Cost Basis</h6>
                <h3 class="text-secondary">$@Model.PortfolioCost.ToString("N2")</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <h6 class="card-subtitle mb-2 text-muted">Unrealized P&L</h6>
                <h3 class="@(Model.UnrealizedPnL >= 0 ? "text-success" : "text-danger")">
                    @(Model.UnrealizedPnL >= 0 ? "+" : "")$@Model.UnrealizedPnL.ToString("N2")
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <h6 class="card-subtitle mb-2 text-muted">Total Trades</h6>
                <h3 class="text-info">@Model.TotalTrades</h3>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Aggregate P&L vs Date</h5>
            </div>
            <div class="card-body">
                <canvas id="pnlChart" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Equity Curve</h5>
            </div>
            <div class="card-body">
                <canvas id="equityChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-cash-coin"></i> Dividends vs Date</h5>
            </div>
            <div class="card-body">
                <canvas id="dividendChart" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Win/Loss Distribution</h5>
            </div>
            <div class="card-body d-flex justify-content-center align-items-center">
                <canvas id="winLossChart" height="200" style="max-width: 300px;"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Light theme colors
        const chartColors = {
            primary: '#0d6efd',
            success: '#198754',
            danger: '#dc3545',
            warning: '#ffc107',
            info: '#0dcaf0',
            text: '#212529',
            textMuted: '#6c757d',
            grid: '#dee2e6',
            cardBg: '#ffffff'
        };

        // Global chart defaults for light theme
        Chart.defaults.color = chartColors.textMuted;
        Chart.defaults.borderColor = chartColors.grid;

        // Data from model
        const cumulativePnLData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.CumulativePnL));
        const equityCurveData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.EquityCurve));
        const cumulativeDividendsData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.CumulativeDividends));
        const dailyDividendsData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DailyDividends));
        const winningTrades = @Model.WinningTrades;
        const losingTrades = @Model.LosingTrades;

        // Helper to format dates
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('T')[0].split('-');
            if (parts.length !== 3) return dateStr;
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = months[parseInt(parts[1], 10) - 1];
            const day = parseInt(parts[2], 10);
            return `${month} ${day}`;
        }

        // P&L Chart
        if (cumulativePnLData.length > 0) {
            const pnlCtx = document.getElementById('pnlChart').getContext('2d');
            new Chart(pnlCtx, {
                type: 'line',
                data: {
                    labels: cumulativePnLData.map(d => formatDate(d.date)),
                    datasets: [{
                        label: 'Cumulative P&L',
                        data: cumulativePnLData.map(d => d.value),
                        borderColor: chartColors.success,
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: chartColors.cardBg,
                            titleColor: chartColors.text,
                            bodyColor: chartColors.text,
                            borderColor: chartColors.grid,
                            borderWidth: 1,
                            callbacks: {
                                label: ctx => `$${ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: chartColors.grid },
                            ticks: { callback: value => '$' + value.toLocaleString() }
                        },
                        x: { grid: { color: chartColors.grid } }
                    }
                }
            });
        }

        // Equity Curve Chart
        if (equityCurveData.length > 0) {
            const equityCtx = document.getElementById('equityChart').getContext('2d');
            new Chart(equityCtx, {
                type: 'line',
                data: {
                    labels: equityCurveData.map(d => formatDate(d.date)),
                    datasets: [{
                        label: 'Equity',
                        data: equityCurveData.map(d => d.value),
                        borderColor: chartColors.primary,
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: chartColors.cardBg,
                            titleColor: chartColors.text,
                            bodyColor: chartColors.text,
                            borderColor: chartColors.grid,
                            borderWidth: 1,
                            callbacks: {
                                label: ctx => `$${ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: chartColors.grid },
                            ticks: { callback: value => '$' + value.toLocaleString() }
                        },
                        x: { grid: { color: chartColors.grid } }
                    }
                }
            });
        }

        // Dividends Chart
        if (cumulativeDividendsData.length > 0) {
            const dividendCtx = document.getElementById('dividendChart').getContext('2d');
            new Chart(dividendCtx, {
                type: 'bar',
                data: {
                    labels: cumulativeDividendsData.map(d => formatDate(d.date)),
                    datasets: [
                        {
                            label: 'Daily Dividend',
                            type: 'bar',
                            data: dailyDividendsData.map(d => d.value),
                            backgroundColor: 'rgba(255, 193, 7, 0.7)',
                            borderColor: chartColors.warning,
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Cumulative',
                            type: 'line',
                            data: cumulativeDividendsData.map(d => d.value),
                            borderColor: chartColors.success,
                            backgroundColor: 'transparent',
                            tension: 0.3,
                            pointRadius: 2,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { labels: { color: chartColors.textMuted } },
                        tooltip: {
                            backgroundColor: chartColors.cardBg,
                            titleColor: chartColors.text,
                            bodyColor: chartColors.text,
                            borderColor: chartColors.grid,
                            borderWidth: 1,
                            callbacks: {
                                label: ctx => `${ctx.dataset.label}: $${ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: chartColors.grid },
                            title: { display: true, text: 'Daily ($)', color: chartColors.textMuted },
                            ticks: { callback: v => '$' + v }
                        },
                        y1: {
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'Cumulative ($)', color: chartColors.textMuted },
                            ticks: { callback: v => '$' + v },
                            position: 'right'
                        },
                        x: { grid: { color: chartColors.grid } }
                    }
                }
            });
        }

        // Win/Loss Pie Chart
        if (winningTrades > 0 || losingTrades > 0) {
            const winLossCtx = document.getElementById('winLossChart').getContext('2d');
            new Chart(winLossCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Winning Trades', 'Losing Trades'],
                    datasets: [{
                        data: [winningTrades, losingTrades],
                        backgroundColor: [chartColors.success, chartColors.danger],
                        borderColor: chartColors.cardBg,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: { color: chartColors.textMuted, padding: 20 }
                        },
                        tooltip: {
                            backgroundColor: chartColors.cardBg,
                            titleColor: chartColors.text,
                            bodyColor: chartColors.text,
                            borderColor: chartColors.grid,
                            borderWidth: 1,
                            callbacks: {
                                label: ctx => {
                                    const total = winningTrades + losingTrades;
                                    const pct = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : 0;
                                    return `${ctx.label}: ${ctx.raw} (${pct}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
}
