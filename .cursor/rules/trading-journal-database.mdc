---
description: TradingJournal database operations - PostgreSQL with Entity Framework Core migrations
globs: ["TradingJournal.Api/Data/**", "TradingJournal.Api/Migrations/**", "TradingJournal.Api/Models/**"]
---

# TradingJournal Database Guide

You are working with the TradingJournal database layer using PostgreSQL and Entity Framework Core.

## Tech Stack

- **Database:** PostgreSQL 15+ (Docker container)
- **ORM:** Entity Framework Core 10.0
- **Provider:** Npgsql.EntityFrameworkCore.PostgreSQL

## Database Connection

**Development (local):**
```
Host=localhost;Database=tradingjournal;Username=tradingjournal;Password=tradingjournal
```

**Docker container name:** `trading-journal-db`

## Schema Overview

```sql
-- Users table
CREATE TABLE users (
    id TEXT PRIMARY KEY,
    email TEXT NOT NULL UNIQUE,
    password TEXT NOT NULL,  -- BCrypt hash
    name TEXT,
    "createdAt" TIMESTAMP WITH TIME ZONE,
    "updatedAt" TIMESTAMP WITH TIME ZONE
);

-- Accounts table
CREATE TABLE accounts (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    currency TEXT DEFAULT 'USD',
    "userId" TEXT REFERENCES users(id) ON DELETE CASCADE
);

-- Trades table (with options support)
CREATE TABLE trades (
    id TEXT PRIMARY KEY,
    symbol TEXT NOT NULL,
    type TEXT NOT NULL,  -- BUY, SELL, BUY_TO_OPEN, etc.
    quantity DOUBLE PRECISION NOT NULL,
    price DOUBLE PRECISION NOT NULL,
    fee DOUBLE PRECISION DEFAULT 0,
    currency TEXT DEFAULT 'USD',
    date TIMESTAMP WITH TIME ZONE NOT NULL,
    notes TEXT,
    -- Options fields
    "instrumentType" INTEGER DEFAULT 0,  -- 0=Stock, 1=Option
    "optionType" INTEGER,  -- 0=Call, 1=Put
    "strikePrice" DOUBLE PRECISION,
    "expirationDate" TIMESTAMP WITH TIME ZONE,
    "underlyingSymbol" TEXT,
    "contractMultiplier" INTEGER DEFAULT 100,
    "spreadType" INTEGER DEFAULT 0,
    "spreadGroupId" TEXT,
    "spreadLegNumber" INTEGER,
    "isOpeningTrade" BOOLEAN,
    -- Foreign keys
    "accountId" TEXT REFERENCES accounts(id) ON DELETE CASCADE,
    "userId" TEXT REFERENCES users(id) ON DELETE CASCADE
);

-- Dividends table
CREATE TABLE dividends (
    id TEXT PRIMARY KEY,
    symbol TEXT NOT NULL,
    amount DOUBLE PRECISION NOT NULL,
    type TEXT DEFAULT 'CASH',
    "paymentDate" TIMESTAMP WITH TIME ZONE NOT NULL,
    "accountId" TEXT REFERENCES accounts(id) ON DELETE CASCADE,
    "userId" TEXT REFERENCES users(id) ON DELETE CASCADE
);

-- Portfolio table (calculated positions)
CREATE TABLE portfolios (
    id TEXT PRIMARY KEY,
    symbol TEXT NOT NULL,
    quantity DOUBLE PRECISION NOT NULL,
    "averagePrice" DOUBLE PRECISION NOT NULL,
    "accountId" TEXT REFERENCES accounts(id) ON DELETE CASCADE,
    "userId" TEXT REFERENCES users(id) ON DELETE CASCADE
);
```

## Entity Framework Core

### DbContext Configuration
```csharp
public class ApplicationDbContext : DbContext
{
    public DbSet<User> Users { get; set; }
    public DbSet<Account> Accounts { get; set; }
    public DbSet<Trade> Trades { get; set; }
    public DbSet<Dividend> Dividends { get; set; }
    public DbSet<Portfolio> Portfolios { get; set; }
    
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        // Cascade deletes
        modelBuilder.Entity<Account>()
            .HasOne(a => a.User)
            .WithMany()
            .OnDelete(DeleteBehavior.Cascade);
    }
}
```

### Model Attributes
```csharp
[Table("trades")]
public class Trade
{
    [Key]
    [Column("id")]
    public string Id { get; set; }
    
    [Required]
    [Column("symbol")]
    public string Symbol { get; set; }
    
    [Column("strikePrice")]
    public double? StrikePrice { get; set; }
}
```

## Migration Commands

```bash
# Navigate to API project
cd TradingJournal.Api

# Create new migration
dotnet ef migrations add MigrationName

# Apply migrations
dotnet ef database update

# List migrations
dotnet ef migrations list

# Revert migration
dotnet ef database update PreviousMigrationName

# Generate SQL script
dotnet ef migrations script
```

## Direct Database Access

```bash
# Connect to PostgreSQL in Docker
docker exec -it trading-journal-db psql -U tradingjournal -d tradingjournal

# Run SQL command
docker exec trading-journal-db psql -U tradingjournal -d tradingjournal -c "SELECT * FROM trades LIMIT 5;"

# Add column manually
docker exec trading-journal-db psql -U tradingjournal -d tradingjournal -c "
ALTER TABLE trades ADD COLUMN IF NOT EXISTS \"newColumn\" TEXT;
"
```

## Important Conventions

1. **DateTime:** Always use UTC with `DateTime.SpecifyKind(date, DateTimeKind.Utc)`
2. **Column names:** Use `[Column("camelCase")]` for PostgreSQL compatibility
3. **Cascade deletes:** Configure in `OnModelCreating` for referential integrity
4. **Nullable:** Use `?` suffix for optional fields (e.g., `double? StrikePrice`)
5. **Enums:** Stored as integers in database

## Common Queries

```csharp
// Get trades with account included
var trades = await _context.Trades
    .Include(t => t.Account)
    .Where(t => t.UserId == userId)
    .OrderByDescending(t => t.Date)
    .ToListAsync();

// Date filtering (UTC)
var startUtc = DateTime.SpecifyKind(startDate.Value, DateTimeKind.Utc);
query = query.Where(t => t.Date >= startUtc);
```
